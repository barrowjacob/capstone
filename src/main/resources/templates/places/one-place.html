<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:insert="partials/fragments :: head('Single Place Page')">
</head>
<body style="background-color: #FAEBD7">
<nav th:insert="partials/fragments :: nav"></nav>
<div style="
            background-image: url('img/boat_icon.png');
            background-repeat: no-repeat;
            background-position: bottom;
            background-size: cover;
            z-index: 1;
            height: 45vh;">
</div>
<article class="tile is-child box" style="background-color: #FAEBD7">
   <div class="columns">
      <div
        style="width: 100%; display: flex; justify-content: center; align-items: center; margin-top: 4%;">
         <div class="column is-narrow is-7"
              style="border: 2px solid black; padding: 0; height: 403px; width: 60%; margin-right: 1px; background-color: white">
            <div th:each="image,iStat : ${place.placeImages}">
               <img th:if="${iStat.first}" th:src="${image.imagePath}"
                    style="padding: 0; margin: 0; height: 400px; width: 100%;"
                    class="is-mobile-1">
            </div>
         </div>
         <div class="column is-one-third-tablet"
              style="display: flex; flex-wrap: wrap; padding: 0; margin: 0; border: 2px solid black; width: 505px; height: 403px; background-color: white ">
            <div th:each="image,iStat : ${place.placeImages}"
                 style="margin: 0 1px 1px 0; height: 199px; display: flex; flex-wrap: wrap;">
               <img th:if="${iStat.count > 1 && iStat.count < 6}"
                    th:src="${image.imagePath}"
                    style="height: 199px; width: 249px;">
            </div>
         </div>
      </div>
   </div>
</article>

<article class="tile is-child box" style="background-color: #FAEBD7">
   <div class="columns" >
      <div class="column is-7 is-narrow" style="margin-left: 2%;">

         <div class="card"
              style="display: flex; justify-content: center; align-items: center; flex-direction: column; width: 100%; border: solid 2px black;">
            <div
              style="display: flex; margin-top: 3%; width: 100%; justify-content: center;">
               <h1 class="is-size-2"
                   style="margin-right: 15%; margin-left: 25%;"
                   th:text="${place.title}"></h1>
               <div
                 style="display: flex; flex-direction: column; justify-content: center; align-items: center; margin-right: 1%;">

                  <a th:href="@{'/profile/' + ${place.user.id}}">
                     <img th:src="${place.user.image_path}"
                          class="image is-64x64"
                          style="border-radius: 50%;">
                  </a>
                  <p th:text="${place.user.username}">
                  </p>
               </div>
            </div>


            <div class="card-body"
                 style="display: flex; justify-content: center; flex-direction: column; align-items: center;">
               <span><strong
                 th:text="'$' + ${place.cost_per_day}"></strong><span> per day</span></span>
               <p th:text="${place.description}"></p>
            </div>
            <div class="card-footer"
                 style="display: flex; justify-content: center; width: 100%;">
               <div class="column"
                    style="display: flex; justify-content: center;">
                  <div style="display: flex; justify-content: center;"
                       th:if="${loggedInUser.id != null && loggedInUser.id != place.user.id}">
                     <form th:method="GET"
                           th:action="@{'/confirmation/' + ${place.id} + '/checkout'}">
                        <input type="hidden" th:field="*{place.id}"
                               placeholder="placeId">
                        <input type="hidden" th:field="*{loggedInUser.id}"
                               th:placeholder="loggedInUserId">
                        <button type="submit" class="button is-primary">
                           <strong>Book
                              Now</strong></button>
                     </form>
                  </div>
                  <div th:if="${loggedInUser.id == place.user.id}">
                     <form th:method="GET"
                           th:action="@{'/places/' + ${place.id} + '/update'}">
                        <input type="hidden" th:value="${place.id}"
                               name="placeId">
                        <button type="submit" class="button is-primary">
                           <strong>Edit</strong>
                        </button>
                     </form>
                  </div>
               </div>
               <input type="hidden" id="address" th:value="${place.address}">
            </div>
         </div>
      </div>

      <!--calendar here-->
      <div style="background-color: white; margin-right: 2%; border: solid 2px black;"
           id="calendar"></div>
   </div>

   <!--    modal-->

   <div class="modal" id="bookModal">
      <div class="modal-background"></div>
      <div class="modal-card">
         <header class="modal-card-head">
            <p class="modal-card-title">Book a Property</p>
         </header>
         <section class="modal-card-body">
            <form th:action="@{'/confirmation/' + ${place.id} + '/checkout'}"
                  th:method="POST">
               <input th:placeholder="title" id="title" type="hidden"
                      th:value="${place.address}" name="address">
               <h2 class="is-size-3" th:text="${place.title}"></h2>
               <h2 class="is-size-3" th:text="${place.address}"></h2>
               <label for="dateStart">Start Date: </label>
               <input placeholder="YYYY/MM/DD" id="dateStart" type="text"
                      name="dateStart">
               <label for="dateEnd">End Date: </label>
               <input placeholder="YYYY/MM/DD" id="dateEnd" type="text"
                      name="dateEnd">
               <input type="hidden" th:value="${place.id}"
                      th:placeholder="placeId" name="placeId">
               <input type="hidden" th:value="${loggedInUser.id}"
                      th:placeholder="loggedInUserId" name="loggedInUserId">
               <input type="hidden" th:value="${place.user.id}"
                      th:placeholder="userId" name="userId">
            </form>
         </section>
         <footer class="modal-card-foot">
            <button class="button" id="closeModal" aria-label="close">
               Cancel
            </button>
               <button class="button is-success" type="submit">Save changes
               </button>
         </footer>
      </div>
   </div>

   <!--    map-->
   <div style="display: flex; justify-content: center;">
      <div id="map"
           style="padding: 0; height: 400px; width: 85%;  border: solid 2px black; background-color: lightgray;">
         <h1 id="address-text" th:text="${place.address}"></h1>
      </div>
   </div>

</article>

<footer th:insert="partials/fragments :: footer"></footer>
<footer th:insert="partials/mapbox_fragments :: mapbox_scripts"></footer>

<script>


    $('#closeModal').click(function () {
        $('#bookModal').toggleClass("is-active")
    });
    mapboxgl.accessToken = mapBoxToken;
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v9',
        zoom: 15,
        center: [-98.4936, 29.4241]
    });
    const markerDetails = {
        color: 'orange',
        draggable: false
    };
    const marker = new mapboxgl.Marker(markerDetails)
        .setLngLat([-98.4936, 29.4241])
        .addTo(map);

    function geocode(search, token) {
        const baseUrl = 'https://api.mapbox.com';
        const endPoint = '/geocoding/v5/mapbox.places/';
        return fetch(baseUrl + endPoint + encodeURIComponent(search) + '.json' + "?" + 'access_token=' + token)
            .then(function (res) {
                return res.json();
                // to get all the data from the request, comment out the following three lines...
            }).then(function (data) {
                return data.features[0].center;
            });
    }

    var address = $('#address').val();
    geocode(address, mapBoxToken)
        .then(function (result) {
            map.flyTo({center: result});
            marker.setLngLat(result);
        });


    $(document).ready(function () {
        var calBookingsBucket = [];
        var req = $.ajax({
            url: '/bookings.json',
            type: "GET",
            contentType: "application/json; charset=utf-8",
            cache: false,
            async: false,
            processData: false,
        });
        req.done(function (bookings) {
            bookings.forEach(function (booking) {
                calBookingsBucket.push({
                    title: booking.title,
                    start: new Date(booking.dateStart),
                    end: new Date(booking.dateEnd),
                })
            });
            console.log(calBookingsBucket);


        }); //for each ends here
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['dayGrid'],
            header: {
                left: 'prev,next,today',
                center: 'title',
                right: 'myCustomButton'

            },


            customButtons: {
                myCustomButton: {
                    text: "Book!",
                    click: function () {
                        $('#bookModal').toggleClass("is-active");

                    }
                }


            },

            events: calBookingsBucket,


        });


        calendar.render();
    }); //end of doc.ready

</script>


</body>
</html>